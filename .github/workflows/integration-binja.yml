name: Binary Ninja Integration

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *"

jobs:
  integration:
    runs-on: self-hosted
    timeout-minutes: 60
    env:
      BINJA_INTEGRATION: "1"
      BINJA_MCP_BASE_URL: ${{ vars.BINJA_MCP_BASE_URL || 'http://localhost:9009' }}
      BINJA_FIXTURE_BINARY: ${{ vars.BINJA_FIXTURE_BINARY || '/bin/ls' }}
      BINJA_SPAWN: ${{ vars.BINJA_SPAWN || '1' }}
      BINJA_BINARY: ${{ vars.BINJA_BINARY }}
      BINJA_LOG_PATH: ${{ vars.BINJA_LOG_PATH || '/tmp/binja-integration.log' }}
      BINJA_UI_DESTRUCTIVE: ${{ vars.BINJA_UI_DESTRUCTIVE || '1' }}
      BINJA_FORCE_RESTART: ${{ vars.BINJA_FORCE_RESTART || '1' }}
      BINJA_KILL_ANY_BINJA: ${{ vars.BINJA_KILL_ANY_BINJA || '0' }}
      BINJA_QPA_PLATFORM: ${{ vars.BINJA_QPA_PLATFORM }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v7

      - name: Validate Binary Ninja spawn config
        run: |
          if [ "${BINJA_SPAWN}" = "1" ]; then
            if [ -z "${BINJA_BINARY}" ]; then
              echo "BINJA_SPAWN=1 requires BINJA_BINARY to point to the Binary Ninja executable"
              exit 1
            fi
            if [ ! -x "${BINJA_BINARY}" ]; then
              echo "BINJA_BINARY is not executable: ${BINJA_BINARY}"
              exit 1
            fi
          fi

      - name: Run non-destructive integration tests
        run: uv run --with pytest pytest -m "binja and not binja_destructive" tests/integration -q

      - name: Run destructive UI integration tests
        if: ${{ env.BINJA_UI_DESTRUCTIVE == '1' }}
        run: uv run --with pytest pytest -m "binja_destructive" tests/integration -q
